# PBI-026: wag_cop - Postcondition Enforcement

## User Story

As a developer using WAG, I need the system to validate my work before allowing completion so that I can make reliable promises to customers.

## Problem

AI drifts. It ignores instructions. It forgets cleanup steps. There's no enforcement - just markdown instructions that AI may or may not follow. You can't build a business on "maybe it works."

## Solution

`wag_cop` - an MCP tool that validates postconditions before allowing mode completion.

- AI calls `wag_cop` when it thinks it's done
- Server runs deterministic checks (not AI judgment)
- If checks pass: allow completion
- If checks fail: return specific failures, AI must fix and retry
- After N failures: deterministic fallback (revert, escalate)

The cop is app-agnostic. It has its own database of common pain points learned across all projects. It doesn't care what app you're building - it knows what fails.

## Architecture

```
wag-mcp (MCP server)
    └── wag_cop tool
            │
            ▼
wagui server (port 3099)
    └── POST /api/v1/cop
            │
            ▼
cop_sessions table (in wagui.db)
```

## Acceptance Criteria

- [x] `wag_cop` MCP tool added to wag-mcp
- [x] `/api/v1/cop` endpoint in wagui server
- [x] cop_sessions table in wagui.db
- [x] Default checks implemented:
  - ADR moved to `adr/completed/` before clear
  - PBI moved to `backlog/_completed/` before clear
  - All acceptance criteria checked `[x]`
  - Quality gates pass (lint, test)
  - Git status clean
- [x] `wag_clear` blocked unless `wag_cop` passed
- [x] Cop returns specific failure messages
- [x] Tests written for cop validation logic

## Technical Notes

Sequence enforcement:
1. AI does work
2. AI calls `wag_cop`
3. If fail: AI fixes, calls `wag_cop` again
4. If pass: AI can call `wag_clear`
5. `wag_clear` rejects if `wag_cop` hasn't passed

## Priority

P0 - This is the core enforcement mechanism

## Dependencies

None

## Estimate

Medium - new MCP tool, new endpoint, new database, sequence enforcement
