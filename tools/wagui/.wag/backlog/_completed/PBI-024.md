# PBI-024: Transcript-Based Conversation Display

## Status

**Superseded by PBI-029** - The polling-based transcript approach was refined and expanded in PBI-029.

## User Story
As a user, I want wagui to display the complete conversation by reading from Claude Code's transcript file so that I get a deterministic, complete view without relying on Claude to manually send messages.

## Problem
The current push model (Claude calling wag_send_message) is unreliable:
- Claude forgets to send messages
- Claude sends summaries instead of actual content
- User messages are missing entirely
- The wagui feed shows incomplete, one-sided conversations

The transcript file (`~/.claude/projects/.../[session-id].jsonl`) already contains the complete conversation - every user message, every Claude response, every tool call.

## Acceptance Criteria
- [ ] Wagui server can watch a transcript file
- [ ] New messages in transcript are parsed and broadcast via SSE
- [ ] User messages appear in wagui automatically
- [ ] Assistant messages appear in wagui automatically
- [ ] Tool calls can optionally be shown
- [ ] A hook or mechanism tells wagui which transcript to watch
- [ ] Tests written for new code

## Technical Notes

### Transcript JSONL Format (Confirmed)
Each line is a JSON object with a `type` field:

**User message:**
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [{"type": "text", "text": "..."}]
  },
  "uuid": "...",
  "timestamp": "2026-01-13T02:38:58.980Z",
  "sessionId": "...",
  "cwd": "..."
}
```

**Assistant message:**
```json
{
  "type": "assistant",
  "message": {
    "role": "assistant",
    "content": [{"type": "text", "text": "..."}, {"type": "tool_use", ...}]
  },
  "uuid": "...",
  "parentUuid": "..."
}
```

**Other types to filter out:**
- `queue-operation`
- `file-history-snapshot`

### Architecture
```
Claude Code writes to transcript.jsonl
         ↓
wagui server watches file (fs.watch/chokidar)
         ↓
Parses new JSONL lines (track file position)
         ↓
Filter: type == "user" || type == "assistant"
         ↓
Extract text content from message.content array
         ↓
Broadcasts via SSE to wagui frontend
         ↓
Frontend displays messages
```

### Session Discovery
Options for telling wagui which file to watch:
1. **Hook on session start** - UserPromptSubmit hook sends transcript path to wagui via POST /api/v1/watch
2. **Manual** - User provides transcript path via wagui UI
3. **Auto-detect** - Watch `~/.claude/projects/` for newest .jsonl file

Recommend: Start with option 1 (hook) as primary, option 2 as fallback.

### New Endpoints
- `POST /api/v1/watch` - Start watching a transcript file
  - Body: `{ "path": "/path/to/transcript.jsonl" }`
- `DELETE /api/v1/watch` - Stop watching
- `GET /api/v1/watch` - Get current watch status

### Files to Change
- `server/index.ts` - Add file watching logic and endpoints
- `src/hooks/useSSE.ts` - Handle new transcript message events
- `src/components/` - May need new component for transcript messages
- New: `hooks/user-prompt-submit.sh` - Hook script to notify wagui of session

### Polling Note
`fs.watch` on WSL uses polling internally. Consider using `chokidar` for better cross-platform support, or accept polling as the reality.

## Priority
P0 - Critical. Without this, wagui is fundamentally broken.

## Dependencies
- None - can proceed immediately

## Estimate
Medium - file watching, parsing, new endpoint