# PBI-029: Transcript Polling & Display

## User Story

As a user, I want wagui to automatically display the conversation from Claude Code's transcript so I see user messages, Claude responses, and interruptions without relying on manual wag_send_message calls.

## Problem

Currently wagui shows only what Claude explicitly sends via `wag_send_message`. This is unreliable:
- Claude forgets to forward messages
- User messages are often missing
- Interruptions aren't captured
- The feed is incomplete

Claude Code writes everything to a transcript file. We should read from that instead.

## Solution

Poll the transcript file for the selected app and parse messages into wagui's format.

## Acceptance Criteria

- [ ] Server derives transcript path from app's appRoot
- [ ] Server polls transcript file for new content
- [ ] File offset tracked to avoid re-reading (transcript_offsets table)
- [ ] Messages deduped by UUID before insert
- [ ] Transcript entries normalized to WagMessage format
- [ ] User messages (`type: "user"`) displayed
- [ ] Assistant text (`type: "assistant"`, content.type: "text"`) displayed
- [ ] Tool calls optionally shown (toggle in UI)
- [ ] Interruptions captured and displayed
- [ ] Switching apps switches transcript watching
- [ ] Messages sorted chronologically (transcript + wag_send_message interleaved)
- [ ] Tests written for transcript parsing

## Technical Notes

### Transcript Location

```
appRoot: /home/samf/source/claude/tools/samx
    → ~/.claude/projects/-home-samf-source-claude-tools-samx/
    → [most recent .jsonl file by mtime]
```

### Offset Tracking Table

```sql
CREATE TABLE transcript_offsets (
    app TEXT PRIMARY KEY,
    file_path TEXT NOT NULL,
    byte_offset INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
)
```

### Transcript Entry Types

| Type | Content | Show? |
|------|---------|-------|
| user | User message | Yes |
| assistant | Claude response (text, tool_use, thinking) | text: Yes, others: optional |
| progress | Streaming updates | No |
| queue-operation | Internal | No |
| file-history-snapshot | File tracking | No |

### Message Normalization

```
Transcript entry:
{
  "type": "user",
  "message": { "content": [{"type": "text", "text": "..."}] },
  "uuid": "abc123",
  "timestamp": "2026-01-22T..."
}

WagMessage:
{
  "id": "abc123",
  "role": "user",
  "type": "chat",
  "content": "...",
  "timestamp": 1737556800000,
  "source": "transcript"  // NEW field to distinguish from wag_send_message
}
```

### Polling

- Poll interval: 500ms (configurable)
- On poll: seek to offset, read new bytes, parse complete lines
- On app switch: stop old watcher, start new watcher
- On new session (different .jsonl file): reset offset, start fresh

## Priority

P0 - Core feature that makes wagui useful

## Dependencies

- PBI-028 (App Registry) - need appRoot to derive transcript path

## Estimate

Large - polling engine, parsing, normalization, offset tracking
