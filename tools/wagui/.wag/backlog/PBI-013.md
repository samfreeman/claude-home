# PBI-013: Implicit PBI-Based Message Grouping

## User Story
As a developer, I want to see all messages related to a specific PBI grouped together so that I can review the full history of work on that feature.

## Problem
Messages are stored chronologically but work on a PBI spans multiple sessions:
- ADR discussion (ADR mode)
- Implementation (DEV mode)
- Bug fixes (DEV mode)
- Follow-up discussions

Currently no way to say "show me everything we did for PBI-006".

## Acceptance Criteria
- [ ] Messages with same PBI metadata are implicitly grouped
- [ ] UI provides PBI filter dropdown to select/view by PBI
- [ ] PBI history shows chronological progression across sessions
- [ ] Works with existing `metadata.pbi` field
- [ ] Clear button to reset filter and show all messages
- [ ] Tests written for new code

## Technical Notes

### Current State
Messages already have optional PBI metadata:
```typescript
wag_send_message({
    role: 'architect',
    type: 'proposal',
    content: '...',
    pbi: 'PBI-006'  // â† Already exists
})
```

### Implementation
1. Ensure all PBI-related messages include `metadata.pbi`
2. Add query: `getMessagesByPBI(pbi: string): WagMessage[]`
3. Add query: `getDistinctPBIs(): { pbi: string, count: number }[]`
4. UI: PBI filter dropdown in toolbar
5. UI: Message count badges per PBI

### Data Requirements
- Index messages by PBI for fast lookup
- Count messages per PBI for UI
- Handle messages without PBI (general discussion)

## UI Requirements

### PBI Filter Dropdown (Toolbar)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ“‹ All PBIs â–¼] [Clear Filter]                  â”‚  â† Toolbar
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€â”€ All PBIs                                   â”‚
â”‚  â”œâ”€â”€ PBI-006 (15)                               â”‚
â”‚  â”œâ”€â”€ PBI-007 (8)                                â”‚
â”‚  â”œâ”€â”€ PBI-012 (3)                                â”‚
â”‚  â””â”€â”€ (No PBI) (22)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Filtered View Indicator
When filter is active, show indicator:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Showing: PBI-006 (15 messages) [âœ• Clear]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  Filtered messages for PBI-006...               â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Interaction Flow
1. User clicks PBI dropdown in toolbar
2. Dropdown shows all PBIs with message counts
3. User selects a PBI
4. Message list filters to show only that PBI's messages
5. Filter indicator appears with clear button
6. User clicks clear to return to all messages

## Priority
P2 - Useful for reviewing past work

## Dependencies
- PBI-001 (SQLite Persistence) - makes grouping more valuable

## Estimate
Small - data already captured, needs query + UI
