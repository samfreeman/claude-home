# PBI-015: Semantic Search with sqlite-vec

## User Story
As a developer, I want to search conversation history using natural language so that I can find relevant discussions without remembering exact PBIs or keywords.

## Problem
Structured queries (by PBI, by tag) require knowing what you're looking for. Sometimes you want:
- "Show me everything about security"
- "What did we decide about the color scheme?"
- "Find discussions about API rate limiting"

Keyword search misses semantic similarity (e.g., "auth" vs "authentication" vs "login").

## Acceptance Criteria
- [ ] Messages are embedded and stored in sqlite-vec
- [ ] UI provides search input for natural language queries
- [ ] Search can be combined with filters (PBI, date range, role)
- [ ] Results are ranked by relevance with match percentage
- [ ] Clicking a result navigates to that message in context
- [ ] Embedding happens asynchronously (doesn't block message flow)
- [ ] Tests written for new code

## Technical Notes

### Architecture
```
New Message                      Search Query
     â”‚                                â”‚
     â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Embed   â”‚                    â”‚ Embed query â”‚
â”‚ content â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
     â”‚                                â–¼
     â–¼                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ vec_search  â”‚
â”‚ SQLite + sqlite-vec     â”‚â—„â”€â”€â”€â”‚ (cosine)    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚messages â”‚ vec_embed â”‚ â”‚           â”‚
â”‚ â”‚ table   â”‚  table    â”‚ â”‚           â–¼
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    Ranked Results
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dependencies
```bash
# sqlite-vec extension
pnpm add sqlite-vec

# Embedding options:
# Option A: OpenAI
pnpm add openai

# Option B: Local via Ollama
# (requires Ollama running locally)
```

### Data Model
```sql
-- Existing messages table
CREATE TABLE messages (
    id TEXT PRIMARY KEY,
    content TEXT,
    role TEXT,
    type TEXT,
    pbi TEXT,
    timestamp INTEGER
);

-- Vector embeddings (sqlite-vec)
CREATE VIRTUAL TABLE vec_messages USING vec0(
    message_id TEXT PRIMARY KEY,
    embedding FLOAT[1536]  -- OpenAI ada-002 dimensions
);
```

### Embedding Strategy
```typescript
// Embed on message insert (async)
async function embedMessage(message: WagMessage) {
    const embedding = await getEmbedding(message.content)
    await db.run(
        'INSERT INTO vec_messages (message_id, embedding) VALUES (?, ?)',
        [message.id, embedding]
    )
}

// Search
async function semanticSearch(query: string, limit = 10) {
    const queryEmbedding = await getEmbedding(query)
    return db.all(`
        SELECT m.*, vec_distance_cosine(v.embedding, ?) as distance
        FROM messages m
        JOIN vec_messages v ON m.id = v.message_id
        ORDER BY distance ASC
        LIMIT ?
    `, [queryEmbedding, limit])
}
```

### Embedding Provider Options

**Option A: OpenAI (Recommended for simplicity)**
- text-embedding-ada-002: $0.0001/1K tokens
- 1536 dimensions
- Fast, reliable

**Option B: Ollama (Local, free)**
- nomic-embed-text or similar
- Requires Ollama running
- No API costs

**Option C: Configurable**
- Support both via interface
- User chooses based on preference

## UI Requirements

### Search Bar (Toolbar)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ“‹ PBIs â–¼] [ğŸ·ï¸ Groups â–¼] [ğŸ” Search conversations...   ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Search Panel (Expanded)
When user focuses search input:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” [What did we decide about authentication?        ] [â] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filters:                                                  â”‚
â”‚ â˜‘ All PBIs  â˜ Current PBI only                           â”‚
â”‚ â˜ Last 7 days  â˜ Last 30 days  â˜‘ All time                â”‚
â”‚ â˜ Architect only  â˜ PM only  â˜‘ All roles                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Search Results Panel
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Results for "authentication" (8 matches)           [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 95% Â· ARCHITECT Â· PBI-006 Â· 2 days ago              â”‚   â”‚
â”‚ â”‚ "We decided to use JWT tokens for authentication..."â”‚   â”‚
â”‚ â”‚                                        [View â†’]     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 87% Â· PM Â· PBI-003 Â· 1 week ago                     â”‚   â”‚
â”‚ â”‚ "The login flow should support OAuth providers..."  â”‚   â”‚
â”‚ â”‚                                        [View â†’]     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 82% Â· DEV Â· PBI-006 Â· 3 days ago                    â”‚   â”‚
â”‚ â”‚ "Implemented the auth middleware with session..."   â”‚   â”‚
â”‚ â”‚                                        [View â†’]     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚ [Load more results...]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Interaction Flows

**Search:**
1. User clicks search input in toolbar
2. Search panel expands with filter options
3. User types natural language query
4. Press Enter or click search button
5. Results panel appears with ranked matches
6. User clicks "View" to jump to message in context

**Jump to Message:**
1. User clicks "View â†’" on a search result
2. Search panel minimizes (but stays accessible)
3. Message list scrolls to that message
4. Message is highlighted briefly
5. Context messages shown above/below

**Clear Search:**
1. User clicks âœ• on results panel
2. Returns to normal message view

### Keyboard Shortcuts
- `Cmd/Ctrl + K` - Focus search input
- `Escape` - Close search panel
- `Enter` - Execute search
- `â†‘/â†“` - Navigate results
- `Enter` on result - View message

## Priority
P3 - Advanced feature, nice to have

## Dependencies
- PBI-001 (SQLite Persistence) - required for storage
- PBI-013 (PBI Grouping) - can filter search by PBI

## Estimate
Large - new infrastructure, embedding pipeline, UI

## Considerations
- **Cold start**: Existing messages need backfill embedding
- **Cost**: OpenAI embeddings cost money (though minimal)
- **Privacy**: Content sent to OpenAI if using their API
- **Latency**: Embedding adds ~100-200ms per message
- **Storage**: 1536 floats Ã— 4 bytes = ~6KB per message

## Future Enhancements
- Summarize search results
- "Related messages" suggestions
- Cross-project search
