# PBI-008: Virtualized Message List for Large History

## User Story
As a developer, I want wagui to handle large message histories without performance degradation so that the UI remains responsive even with thousands of messages.

## Problem
Currently, wagui renders all messages as DOM nodes. With SQLite persistence (PBI-001), we could load thousands of messages on startup, causing:
- High memory usage
- Slow initial render
- Sluggish scrolling
- Potential browser crashes at 50k+ messages

## Acceptance Criteria
- [ ] Message list uses virtualization (only visible items rendered)
- [ ] Smooth scrolling with 10k+ messages
- [ ] Auto-scroll to bottom on new messages (when already at bottom)
- [ ] Dynamic height support for varying message sizes
- [ ] Memory usage stays constant regardless of message count
- [ ] Tests written for new code

## Technical Notes

### Library
Use `@tanstack/react-virtual` (~10KB gzipped)

```bash
pnpm add @tanstack/react-virtual
```

### Implementation
Replace current message map with virtualized list:

```tsx
import { useVirtualizer } from '@tanstack/react-virtual'

function MessageList({ messages }: { messages: WagMessage[] }) {
    const parentRef = useRef<HTMLDivElement>(null)

    const virtualizer = useVirtualizer({
        count: messages.length,
        getScrollElement: () => parentRef.current,
        estimateSize: () => 80,
        overscan: 5
    })

    return (
        <div ref={parentRef} className="h-full overflow-auto">
            <div style={{ height: virtualizer.getTotalSize() }}>
                {virtualizer.getVirtualItems().map(virtualRow => (
                    <div
                        key={virtualRow.key}
                        style={{
                            position: 'absolute',
                            top: virtualRow.start,
                            width: '100%'
                        }}
                    >
                        <MessageBubble message={messages[virtualRow.index]} />
                    </div>
                ))}
            </div>
        </div>
    )
}
```

### Considerations
- Need `measureElement` for dynamic heights
- Auto-scroll: check if user is at bottom before scrolling on new message
- May need to adjust context dividers (PBI-005) to work with virtualization

## Priority
P2 - Future-proofing. Current 100-message cap works fine for now.

## Dependencies
- PBI-001 (SQLite Persistence) - makes this more urgent
- PBI-005 (Context Dividers) - may need adjustment

## Estimate
Medium - refactor message list component, handle edge cases
