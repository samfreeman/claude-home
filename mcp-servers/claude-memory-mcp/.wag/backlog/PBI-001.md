# PBI-001: WalConflict Recovery

## Problem
When the MCP server goes offline, writes accumulate in the local WAL file. On reconnect, if the remote state diverged, `client.sync()` throws `WalConflict` and the server crashes. There is no recovery — offline writes are lost if the WAL is manually deleted.

## Requirement
On WalConflict during `initDb`'s initial sync, preserve local data before clearing the WAL.

## Approach
1. Catch WalConflict during initial `client.sync()`
2. Close failed client
3. Reopen local DB in local-only mode (no syncUrl) to read stranded data
4. Dump all rows from: facts, hardware, projects, inbox, relays, relay_context, relay_tasks
5. Close local-only client, delete WAL + SHM files
6. Reconnect with Turso sync (clean remote state)
7. Reconcile — merge salvaged rows back:
   - facts/hardware/projects: `INSERT OR IGNORE` (unique constraints handle dedup)
   - inbox: match by source+target+title+created, insert if missing
   - relays: match by title+created, insert if missing, track old_id -> new_id
   - relay_context/relay_tasks: re-insert with mapped relay_id

## Acceptance Criteria
- [ ] WalConflict caught during initDb initial sync
- [ ] Local data salvaged before WAL deletion
- [ ] Reconciliation merges offline writes back into Turso
- [ ] Server starts successfully after recovery
- [ ] Recovery steps logged to stderr
- [ ] Tests written for recovery path
